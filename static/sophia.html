<html>
  <meta charset="utf-8">
  <head>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css">
    <link rel="stylesheet" href="css/autn.css">
  </head>
  <style>
  </style>
  <body>
    <header class="main-header">
      <div class="main-logo">
        <img src="./img/hp_logo_blue.png" class="img-logo">
      </div>
      <h1 class="main-title">Sophia</h1>
    </header>

    <section style="width: 1600px;">
      <div style="margin-left: 10px; margin-top: 0px;">
        <aside style="width: 400px;">
          <div class="entry-content">
            <article class="entry widget">  
              <h3 class="section-title">Test Steps</h3>
              <div class="entry-wrapper">
                <div id='prevQueries' class='table'></div>
                <!--form name='query_form' action="#"-->
                  <div>
                    <label for="q">Description:</label>
                    <input type="Text" name="q" id="q" placeholder="Enter Query Text" class="ui-widget ui-corner-all" style="width:100%;">
                  </div>
                  <div>
                    <label for="dateBiasRange">Expected Results:</label>
                    <input type="Text" name="expected" id="expected" placeholder="Enter Expectd Results" class="ui-widget ui-corner-all" style="width:100%;">
                </div>
                <div class="table-row">
                  <button id='nfj_query' class='ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only' style="width:100px; height: 30px;">Submit</button>
                </div>
                <div class="table-row">
                  <section id="errorsAndWarnings" class="final-details"></section>
                </div>
              <!--/form-->
            </article>
          </div>
        </aside>
        <aside style="width: 1150px; float: right;">
          <div class="entry-content">
            <article class="entry widget">  
              <h3 class="section-title">Graph Results</h3>
              <div class="entry-wrapper graph" id='graphWrapper'>
                <section class="right">
                  <div id="graph_container"></div>
                </section>
              </div>
            </article>
          </div>
        </aside>
        <div id='details'>
        <div class='header'><span></span><a href="#" class="close" onclick="hideDetails();">X</a></div>
          <table id='properties'>
          </table>  
        </div>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="js/jquery-2.1.0.js"></script>
        <script src="js/jquery-ui-1.10.4.custom.min.js"></script>
      </div>
    </section>
    <script>
      var lastNode;
      var nodeR = 30;

      $(document).ready(function() {
        $('#nfj_query').click(function() {
          if ($('#q').val().length == 0) {
            error('Step Description cannot be empty');
            return false;
          }
          if ($('#expected').val().length == 0) {
            error('Expected Results cannot be empty');
            return false;
          }
          var expectedArr = $('#expected').val().split(" ");
          if (expectedArr.length != 4) {
            error('Expected results must contain 4 parts:<br>{entity name} {property} {sign} {value}.<br> For example: ServerCPU AVG > 4');
            return false;
          }

          runQuery( $('#q').val(), $('#expected').val());

          var numRows = $('#prevQueries tr').length;

          var tr, td;
          tr = $('<tr>');
          tr.addClass('table-row');

          if (numRows == 0) {
            numRows = 1;
            // add header
            td = $('<td>');
            td.addClass('table-cell border bold')
            td.text('Step');
            td.appendTo(tr);
            td = $('<td>');
            td.addClass('table-cell border bold')
            td.text('Description');
            td.appendTo(tr);
            td = $('<td>');
            td.addClass('table-cell border bold')
            td.text('Expected Results');
            td.appendTo(tr);
/*            td = $('<td>');
            td.addClass('table-cell border bold')
            td.text('Status');
            td.appendTo(tr);
*/            
            tr.appendTo($('#prevQueries'));
          }

          // add index row
          tr = $('<tr>');
          tr.addClass('table-row');
          td = $('<div>');
          td.addClass('table-cell border');
          td.text(numRows);
          td.appendTo(tr);
          td = $('<div>');
          td.addClass('table-cell border');
          td.text($('#q').val());
          td.appendTo(tr);
          td = $('<div>');
          td.addClass('table-cell border');
          td.text($('#expected').val());
          td.appendTo(tr);
          tr.appendTo($('#prevQueries'));

          $('#q').val('');
          $('#expected').val('');
        });

        var width = 1150,
            height = $('#graphWrapper').css('height').replace('px', '');

        var color = d3.scale.category20();

        var force = d3.layout.force()
            .charge(-120)
            .linkDistance(120)
            .size([width, height]);

        var svg;

        function runQuery(query, expected) {
          d3.select("#graph_container").html('');
          svg = d3.select("#graph_container").append("svg")
            .attr("width", width)
            .attr("height", height);

          d3.json("/query?q=" + query + "&expected=" + expected, function(error, graph) {
            // create a lookup of node id to node index
            var lookupIndex = {};
            for (var i=0;i<graph.nodes.length;i++) {
              lookupIndex[graph.nodes[i].id] = i;
            }
            graph.links.forEach(function(link) {
              link.source = lookupIndex[link.source];
              link.target = lookupIndex[link.target];
            });
            force
              .nodes(graph.nodes)
              .links(graph.links)
              .start();

            var link = svg.selectAll(".link")
              .data(graph.links)
              .enter().append("line")
              .attr("class", "link")
              .style("stroke-dasharray", function(d) {
                if (d.value == 'FAR') {
                  return 5,5;
                } else {
                  return 0,0;
                }
              })
              .style("stroke-width", function(d) {
                if (d.value == 'FAR') {
                  return 5;
                } else {
                  return 5;
                }
              });

            var node = svg.selectAll(".node")
              .data(graph.nodes)
              .enter().append("circle")
              .attr("class", "node")
              .attr("r", nodeR)
              .style("fill", function(d) { 
                return color(d.label); 
              })
              .call(force.drag);

            node.append("title")
              .text(function(d) { return d.name; });

            var labels = svg.selectAll("text")
              .data(graph.nodes)
              .enter()
              .append("text")
              .attr("class", "node-text")
              .attr({"x":function(d){ return d.x; },
                     "y":function(d){return d.y;}})
              .text(function(d){return getNodeLabel(d);})
              .call(force.drag);

            force.on("tick", function() {
              link.attr("x1", function(d) { return d.source.x; })
              .attr("y1", function(d) { return d.source.y; })
              .attr("x2", function(d) { return d.target.x; })
              .attr("y2", function(d) { return d.target.y; });

              node.attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; });

              labels.attr("x", function(d) { return d.x + 40; })
                .attr("y", function(d) { return d.y -15; }); 
            });

            svg.selectAll("circle.node").on("click", function(){
              nodeOnClick(this, node, link, labels);
            });
          });
        }

        function nodeOnClick(nodeObj, node, link, labels) {
          if (typeof lastNode != 'undefined') {
            d3.select(lastNode)
              .style("stroke","white");
            }
            lastNode = nodeObj;
            d3.select(nodeObj)
              .style("stroke","red");
            var props = nodeObj.__data__.properties;
            if (props != undefined) {
              var list = '';
              for(var key in props) {
                if(props.hasOwnProperty(key)) {
                  list += '<tr><td class="key_text">' + key + ' </td><td class="value_text">' + props[key] + '</td></tr>';
                }
              }
              $('#details > table').html(list);
              $('#details > div.header > span').text(nodeObj.__data__.name);
              $('#details').css('visibility', 'visible');
              d3.json("/expand?id=" + nodeObj.__data__.id, function(error, graph) {
                var nodes = force.nodes();
                var currIndex = nodes.length;
                var links = force.links();
                for (var i=0;i<graph.nodes.length;i++) {
                  if (findNodeById(nodes, graph.nodes[i].id) == null) {
                    nodes.push(graph.nodes[i]);
                  }
                }
                node = node.data(nodes);
                node.enter().insert("circle", ".cursor")
                .attr("class", "node")
                .attr("r", nodeR)
                .style("fill", function(d) { 
                  return color(d.label); 
                })      
                .call(force.drag);
                
                node.append("title")
                  .text(function(d) { return d.name; });

                labels = labels.data(nodes);
                labels.enter().insert("text", ".node")
                .attr("class", "node-text")
                .attr({"x":function(d){ 
                    return d.x; 
                  },
                   "y":function(d){return d.y;}})
                .text(function(d){return getNodeLabel(d);})
                .call(force.drag);

                var l;
                for (i=0;i<graph.links.length;i++) {
                  l = graph.links[i];
                  l.source = getNodeIndex(nodes, l.source);
                  l.target = getNodeIndex(nodes, l.target);
                  if (findNodeById(graph.links, l.source, l.target) == null) {
                    links.push(l);
                  }
                }
                link = link.data(links);
                link.enter().insert("line", ".node")
                .attr("class", "link")
                .style("stroke-width", 5);

                force.charge(function(d) {
                  if (d.label == 'TestStep' || d.label == 'UserAction') {
                    return -500;
                  } else {
                    return -1000;
                  }
                })
                  .linkDistance(120)
                  .start();

                force.on("tick", function() {
                  link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

                  node.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });

                  labels.attr("x", function(d) { return d.x + 40; })
                  .attr("y", function(d) { return d.y -15; }); 
                });

                svg.selectAll("circle.node").on("click", function(){
                  nodeOnClick(this, node, link, labels);
                });
              });
            }

        }

        function findNodeById(nodes, id) {
          for (var i = 0; i < nodes.length; i++) {
            if (nodes[i].id == id) {
              return nodes[i];
            }
          }
          return null;
        }

        function findLinkByIds(links, from, to) {
          for (var i = 0; i < links.length; i++) {
            if (links[i].source == from && links[i].target == to) {
              return links[i];
            }
          }
          return null;
        }

        function getNodeIndex(nodes, id) {
          for (var i = 0; i < nodes.length; i++) {
            if (nodes[i].id == id) {
              return i;
            }
          }
          return null;
        }

        function getNodeLabel(d) {
          if (d.label == 'Test') {
            return 'Test ' + d.properties.TestNumber;
          } else if (d.label == 'TestStep') {
            var title;
            if (d.name.length > 15) {
              title = d.name.substring(0,15) + '...';
            } else {
              title = d.name;
            }
            title = title +': ' + d.properties.Status;
            return title;
          } else if (d.label == 'ServerRequest') {
            if (d.properties.HTTP_result == '200') {
              return '200 OK';
            } else {
              return 'Error ' + d.properties.HTTP_result;
            }
          } else if (d.label == 'ServerCPU') {
            return 'CPU: ' + d.properties.AVG;
          } else if (d.label == 'ServerMemory') {
            return 'Used: ' + d.properties.VIRTUAL_USED_PRECENT;
          }
          return d.label;
        }
      });

      function hideDetails() {
        $('#details').css('visibility', 'hidden');
      }

      function renderError(errors) {
       clearErrors();
        renderErrorWithoutClear(errors);
        $('#errorsAndWarnings').fadeIn();
      }

      function renderErrorWithoutClear(errors) {
        $.each(errors, function(index, error) {
          $('#errorsAndWarnings').append('<p class="' + error.type + '"><span></span>' + error.message + '</p>');
        });
      }

      function clearErrors() {
        $('#errorsAndWarnings').html('');
        $('#errorsAndWarnings').hide();
      }

      function error(text) {
        renderError([{type: 'error', message: text}]);
        setTimeout(function() {
          clearErrors();
        }, 7000);
      }

    </script>
  </body>
</html>